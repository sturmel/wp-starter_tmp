# WordPress Starter with Automation Stack

This repository contains a complete Docker-based WordPress stack with integrated automation and artificial intelligence services. The project combines WordPress with n8n (automation), Qdrant (vector database), PostgreSQL, Redis and MySQL to create a modern and extensible development environment.

## üéØ Overview

**Main Stack:**
- **WordPress**: Main CMS with Timber parent theme and Tiz child theme
- **n8n**: Workflow automation platform
- **Qdrant**: Vector database for AI/ML
- **PostgreSQL**: Database for n8n
- **MySQL**: WordPress database
- **Redis**: Cache and session management

**Key Integrations:**
- Contact Form 7 connected to n8n via custom webhooks (Tiz theme)
- Timber parent theme with Twig and extensible PHP libraries
- Tiz child theme with modern front-end stack
- CI/CD pipeline ready for Bitbucket

## üìã Prerequisites

- Docker Engine and Docker Compose plugin
- Node.js 18+ (for front-end development)
- Composer (for PHP dependencies)

## üöÄ Quick Start

### Initial Configuration

1. **Copy the environment file:**
   ```bash
   cp .env.example .env
   ```

2. **Configure environment variables:**
   - `WORDPRESS_ENV=development` for local development
   - `WORDPRESS_ENV=production` for production
   - Adjust ports and passwords according to your needs

### Development Setup

1. **Install theme dependencies:**
   ```bash
   # Timber Theme (PHP dependencies)
   cd wordpress/wp-content/themes/timber-starter-theme
   composer install
   ```

   ```bash
   # Tiz Theme (Node.js dependencies)
   cd wordpress/wp-content/themes/tiz
   npm install
   ```

2. **Start the Docker stacks:**
   ```bash
   # WordPress stack (Web)
   docker compose up -d

   # Automation stack (n8n, Postgres, Qdrant) - optional
   docker compose -f docker-compose.n8n.yml up -d
   ```

3. **Launch front-end development (Tiz theme):**
   ```bash
   cd wordpress/wp-content/themes/tiz
   npm run dev
   ```
   This starts Webpack in watch mode and BrowserSync for automatic reloading.

4. **Access services:**
   - WordPress: http://localhost:8080
   - BrowserSync (if enabled): http://localhost:3000
   - n8n (if automation stack started): http://localhost:5678

### Production Deployment

1. **Configure production environment:**
   ```bash
   # In server's .env file
   WORDPRESS_ENV=production
   # Add all production URLs, database credentials, API keys, etc.
   ```

2. **Deployment via CI/CD:**
   Production assets and dependencies are automatically built by the Bitbucket pipeline:
   - **Timber Theme**: `composer install --prefer-dist --no-dev --optimize-autoloader`
   - **Tiz Theme**: `npm ci` then `npm run build`
   - Optimized artifacts are ready for deployment

3. **Start the stack with production assets:**
   ```bash
   docker compose up -d
   ```
   The application will read configuration from the server's `.env` file.

**‚ö†Ô∏è Important:** 
- Do not manually run `composer install` or `npm install/build` in production. Use only artifacts generated by CI/CD to ensure reproducibility and optimization.
- Production runtime configuration (database credentials, API keys, URLs) should be in the server's `.env` file, not in Bitbucket variables.

## üöÄ CI/CD (Bitbucket Pipelines & GitHub Actions)

**Configuration:**
- Bitbucket: `bitbucket-pipelines.yml`
- GitHub: `.github/workflows/deploy.yml`

### Pipeline Steps

1. **Build Timber Theme (Parent Theme)**
   - Image: `composer:latest`
   - Commands: `composer install --prefer-dist --no-dev --optimize-autoloader`
   - Directory: `timber-starter-theme`
   - Result: Optimized PHP dependencies for production

2. **Build Tiz Theme (Child Theme)**
   - Image: `node:22`
   - Commands: 
     ```bash
     npm ci
     npm run build
     ```
   - Directory: `tiz`
   - Result: Compiled, minified and optimized front-end assets

3. **Deployment Artifacts**
   - PHP dependencies ready for production (without dev-dependencies)
   - Optimized front-end assets in `dist/` directory
   - Source code and configuration ready for deployment
   - All necessary files packaged for production server


### CI/CD Best Practices
- **Complete automation**: All builds are managed by the pipeline
- **Reproducibility**: Same build environment for every deployment
- **Optimization**: Minified assets and production-only dependencies
- **Validation**: Automatic tests before deployment

### Branch Workflow

- **Active branches**: `main` (production source of truth), `stage` (pre-production), feature branches created from `stage`.
- **Feature cycle**: step 1 branch from `stage` (`feature/...`); step 2 develop and test locally with the Docker stack; step 3 merge back into `stage` via Pull Request or local merge; step 4 push to `stage` to trigger the staging pipeline that rebuilds assets and deploys to pre-production; step 5 run acceptance tests in pre-production.
- **Production release**: step 1 merge `stage` into `main` after validation; step 2 push to `main` to trigger the production pipeline, reusing the artifacts built on `stage` for deployment to production.

### Pipeline Variables

**Bitbucket Variables:**
- `THEME_NAME`: WordPress theme directory (`tiz` by default)
- `SSH_USER_PREPROD`, `SSH_HOST_PREPROD`, `DEPLOY_PATH_PREPROD`
- `SSH_USER_PROD`, `SSH_HOST_PROD`, `DEPLOY_PATH_PROD`

**GitHub Secrets:**
- `THEME_NAME` (optional, in Variables)
- `SSH_PRIVATE_KEY_PREPROD`, `SSH_HOST_PREPROD`, `SSH_USER_PREPROD`, `DEPLOY_PATH_PREPROD`
- `SSH_PRIVATE_KEY_PROD`, `SSH_HOST_PROD`, `SSH_USER_PROD`, `DEPLOY_PATH_PROD`

**Note:** For GitHub, configure "Required reviewers" on the `production` environment to enable manual approval before production deployment.

### Stopping the Stacks

```bash
# Stop WordPress stack (preserves data)
docker compose down

# Stop Automation stack (preserves data)
docker compose -f docker-compose.n8n.yml down

# Stop with volume removal (DESTRUCTIVE)
docker compose down -v
docker compose -f docker-compose.n8n.yml down -v
```

## üîß Services and Infrastructure

The infrastructure is split into two separate Docker Compose files for independent lifecycle management:
- **`docker-compose.yml`**: WordPress stack (WordPress, MySQL, Redis)
- **`docker-compose.n8n.yml`**: Automation stack (n8n, PostgreSQL, Qdrant)

### WordPress
- **Port**: 8080
- **Themes**: Mounted from `wordpress/wp-content/themes/`
- **Configuration**: Via environment variables and `wp-config.php`
- **Database**: MySQL

### n8n (Automation)
- **Port**: `${N8N_PORT}` (default: 5678)
- **Database**: PostgreSQL
- **Volume**: `n8n-data` for workflow persistence
- **Integration**: Webhook reception from Contact Form 7

### MySQL
- **Role**: WordPress database
- **Configuration**: Credentials via `.env`
- **Volume**: `db-data`

### Redis
- **Port**: `${REDIS_PORT}`
- **Usage**: Cache, sessions, queues
- **Volume**: `redis-data`

### PostgreSQL
- **Role**: Database for n8n
- **Volume**: `postgres-data`
- **Configuration**: Automatic via Docker Compose

### Qdrant
- **Port**: `${QDRANT_PORT}` (default: 6333)
- **Role**: Vector database for AI
- **Volume**: `qdrant-data`
- **API**: REST and gRPC available

## üí° Development Tips

### Local Development
- The `wordpress/` directory is mounted in the container ‚Üí immediate modifications
- Use `docker compose exec wordpress bash` for WP-CLI or Composer in the container
- For Tiz theme: `npm run dev` activates watch mode + BrowserSync
- BrowserSync proxies WordPress on port 3000 with automatic reload

### Debugging and Logs
```bash
# Logs for WordPress stack
docker compose logs -f wordpress
docker compose logs -f db

# Logs for Automation stack
docker compose -f docker-compose.n8n.yml logs -f n8n
docker compose -f docker-compose.n8n.yml logs -f postgres

# Shell access to containers
docker compose exec wordpress bash
docker compose -f docker-compose.n8n.yml exec postgres bash
```

## üé® WordPress Themes

### Timber Starter Theme (Parent Theme)

**Location:** `wordpress/wp-content/themes/timber-starter-theme`

**Features:**
- **Parent theme** that integrates the Timber framework to use **Twig** in WordPress
- Allows integration of **additional PHP libraries** via **Composer**
- **Twig templates** for modern and secure syntax
- Clear separation between PHP logic (`src/`) and templates (`views/`)
- Integrated unit tests with PHPUnit
- Object-oriented architecture with custom classes

**What this theme provides:**
- **Twig templating**: Clear and secure syntax for templates
- **Structured context**: Data organization for views
- **Extensibility**: Easy integration of PHP libraries via Composer
- **Performance**: Twig template caching
- **Security**: Automatic protection against XSS vulnerabilities

**Structure:**
- `src/StarterSite.php`: Main theme class
- `views/`: Twig templates
- `static/`: Static assets
- `tests/`: PHPUnit tests
- `composer.json`: PHP dependencies (Timber + additional libraries)

**Development usage:**
```bash
cd wordpress/wp-content/themes/timber-starter-theme
composer install
```

### Tiz Theme (Child Theme)

**Location:** `wordpress/wp-content/themes/tiz`

**Features:**
- **Child theme** of Timber Starter Theme
- Inherits Timber/Twig functionality from parent theme
- Modern front-end stack with **Webpack 5**
- **Tailwind CSS 4** for styling
- **GSAP** for animations
- **BrowserSync** for real-time development
- Optimized build for production

**Parent/Child Relationship:**
- Automatically inherits all features from Timber parent theme
- Can override parent Twig templates if necessary
- Access to all PHP libraries installed via Composer in parent theme
- Combines Timber/Twig advantages with modern front-end workflow

**Advanced Features:**
- **Contact Form 7** integration with custom webhooks
- Custom Post Types system
- Conditional assets based on environment:
  - Development: `dev_build/` (hot reload)
  - Production: `dist/` (optimized and minified)

**Available Scripts:**
```bash
npm run dev      # Development mode with watch and BrowserSync
npm run build    # Optimized production build
```

**Asset Architecture:**
- Development mode: Webpack watch + BrowserSync on port 3000
- Production mode: Minified and optimized assets in `dist/`

## üîó Contact Form 7 ‚Üî n8n Integration

The Tiz theme includes a custom webhook system for Contact Form 7 that enables seamless integration with n8n.

### Features

**Custom Post Type "CF7 Webhooks":**
- Admin interface to map CF7 forms to webhook URLs
- Per-form configuration of n8n destination URL
- Automatic data sending management

**Integration Process:**
1. **Configuration**: In WordPress admin, create a "CF7 Webhook" and associate a CF7 form with an n8n URL
2. **Submission**: When the form is submitted, CF7 emails are disabled
3. **Webhook**: Data is automatically POSTed as JSON to n8n
4. **Response**: Success/failure status is displayed to the user

### n8n Configuration

1. **n8n Webhook**: Create an n8n workflow with a "Webhook" trigger
2. **Webhook URL**: Copy the generated URL into the "CF7 Webhooks" interface
3. **Processing**: Configure the n8n workflow to process received data
4. **Response**: n8n must respond with `{"ok": true}` to confirm reception

## üóÑÔ∏è Data Services for n8n

### PostgreSQL
- **Role**: Main database for n8n
- **Configuration**: Automatically configured via environment variables
- **Persistence**: Docker volume `postgres-data`

### Qdrant (Vector Database)
- **Role**: Vector storage and search for AI/ML
- **Port**: Configurable via `${QDRANT_PORT}` (default: 6333)
- **Usage**: Perfect for n8n workflows involving:
  - Semantic search
  - Recommendations
  - Text classification
  - RAG (Retrieval Augmented Generation)

**Example usage with n8n:**
- WordPress content embedding in Qdrant
- Semantic search for similar content
- Recommendation system based on user interactions

---

## üìÅ Volumes and Persistence

The stack uses named Docker volumes for data persistence:

- `db-data`: MySQL data (WordPress)
- `postgres-data`: PostgreSQL data (n8n)
- `redis-data`: Redis cache
- `qdrant-data`: Qdrant collections and indexes
- `n8n-data`: n8n workflows and configuration

**‚ö†Ô∏è Warning:** Deleting volumes permanently erases persisted data.

```bash
# Stop and remove volumes (DESTRUCTIVE)
docker compose down -v

# Simple stop (preserves data)
docker compose down
```

## üõ†Ô∏è Troubleshooting

### Common Issues

**Ports already in use:**
- Check that ports defined in `.env` are free
- Modify ports in `.env` if necessary

**CI dependency failures:**
- Verify presence of `composer.lock` and `package-lock.json`
- Ensure cache directories are writable

**Container issues:**
```bash
# Check logs for a specific service
docker compose logs -f <service>

# Restart a specific service
docker compose restart <service>

# Rebuild images
docker compose build --no-cache
```

**CF7 ‚Üí n8n webhooks:**
- Verify that n8n URL is accessible from WordPress
- Check WordPress logs: `/wp-content/debug.log`
- Verify that n8n responds with `{"ok": true}`

### n8n Debugging
- Web interface: http://localhost:5678
- Real-time logs: `docker compose logs -f n8n`
- Webhook testing: use n8n's built-in test tool

### Performance and Optimization
- **Redis**: Enable WordPress object cache
- **Qdrant**: Optimize collection size according to your data
- **MySQL**: Adjust `innodb_buffer_pool_size` for large volumes

## üìù Technical Notes

### Security
- Change all default passwords in production
- Use HTTPS in production
- Limit access to service ports (PostgreSQL, Redis, etc.)

### Backup
- Regularly backup Docker volumes
- Export n8n workflows from the interface
- Backup WordPress database

### Monitoring
- Monitor Docker Compose logs
- Monitor container resource usage
- Regularly check n8n webhook health
