definitions:
  caches:
    composer: ~/.composer/cache
    node: ~/.npm
  steps:
    - step: &build-php 
        name: Build PHP (Timber)
        image: composer:2
        caches:
          - composer
        script:
          - cd wordpress/wp-content/themes/timber-starter-theme
          - composer install --prefer-dist --no-dev --optimize-autoloader
        artifacts:
          - wordpress/wp-content/themes/timber-starter-theme/vendor/**
          
    - step: &build-js-css
        name: Build JS/CSS
        image: node:22
        caches:
          - node
        script:
          - 'THEME_NAME=${THEME_NAME:-tiz}'
          - 'THEME_PATH="wordpress/wp-content/themes/${THEME_NAME}"'
          - 'echo "Using theme: ${THEME_NAME}"'
          - 'cd "${THEME_PATH}"'
          - npm ci || npm install
          - npm run build
        artifacts:
          - wordpress/wp-content/themes/*/assets/**

pipelines:
  branches:
    
    stage:
      - step: *build-php     
      - step: *build-js-css
      - step:
          name: âœ… Deploy to Pre-production
          script:
            - echo "DÃ©ploiement en PREPROD..."
            - rsync -avz --delete \
              --exclude '.env' \
              --exclude 'wp-config.php' \
              --exclude 'node_modules/' \
              --exclude '.git/' \
              --exclude 'wp-content/uploads/' \
              ./wordpress/ $SSH_USER_PREPROD@$SSH_HOST_PREPROD:$DEPLOY_PATH_PREPROD

    main:
      - step: *build-php  
      - step: *build-js-css  
      - step:
          name: ðŸ›‘ Deploy to PRODUCTION
          trigger: manual 
          script:
            - echo "DÃ©ploiement en PRODUCTION..."
            - rsync -avz --delete \
              --exclude '.env' \
              --exclude 'wp-config.php' \
              --exclude 'node_modules/' \
              --exclude '.git/' \
              --exclude 'wp-content/uploads/' \
              ./wordpress/ $SSH_USER_PROD@$SSH_HOST_PROD:$DEPLOY_PATH_PROD
           
options:
  size: 2x