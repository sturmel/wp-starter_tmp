definitions:
  caches:
    composer: ~/.composer/cache
    node: ~/.npm
  steps:
    - step: &build-php 
        name: Build PHP (Timber)
        image: composer:2
        caches:
          - composer
        script:
          - cd wordpress/wp-content/themes/timber-starter-theme
          - composer install --prefer-dist --no-dev --optimize-autoloader
        artifacts:
          - wordpress/wp-content/themes/timber-starter-theme/vendor/**
          
    - step: &build-js-css-prod
        name: Build JS/CSS (Production)
        image: node:22
        caches:
          - node
        script:
          - 'THEME_NAME=${THEME_NAME:-tiz}'
          - 'THEME_PATH="wordpress/wp-content/themes/${THEME_NAME}"'
          - 'echo "Using theme: ${THEME_NAME}"'
          - 'cd "${THEME_PATH}"'
          - npm ci || npm install
          - npm run build
        artifacts:
          - wordpress/wp-content/themes/*/dist/**

    - step: &build-js-css-stage
        name: Build JS/CSS (Pre-production)
        image: node:22
        caches:
          - node
        script:
          - 'THEME_NAME=${THEME_NAME:-tiz}'
          - 'THEME_PATH="wordpress/wp-content/themes/${THEME_NAME}"'
          - 'echo "Using theme: ${THEME_NAME}"'
          - 'cd "${THEME_PATH}"'
          - npm ci || npm install
          - npm run build:dev
        artifacts:
          - wordpress/wp-content/themes/*/dev_build/**

pipelines:
  branches:
    
    stage:
      - step: *build-php     
      - step: *build-js-css-stage
      - step:
          name: Deploy to Pre-production
          script:
            - echo "Déploiement en PREPROD..."
            - rsync -avz --delete \
              --exclude '.env' \
              --exclude 'wp-config.php' \
              --exclude 'node_modules/' \
              --exclude '.git/' \
              --exclude 'wp-content/uploads/' \
              ./wordpress/ $SSH_USER_PREPROD@$SSH_HOST_PREPROD:$DEPLOY_PATH_PREPROD
            - echo "Running post-deploy commands..."
            - ssh $SSH_USER_PREPROD@$SSH_HOST_PREPROD "cd $DEPLOY_PATH_PREPROD && wp core update-db --allow-root && wp theme activate ${THEME_NAME:-tiz} --allow-root && wp cache flush --allow-root && wp rewrite flush --allow-root"
            - echo "Post-deploy completed!"

    main:
      - step: *build-php  
      - step: *build-js-css-prod  
      - step:
          name: Deploy to PRODUCTION
          trigger: manual 
          script:
            - echo "Déploiement en PRODUCTION..."
            - rsync -avz --delete \
              --exclude '.env' \
              --exclude 'wp-config.php' \
              --exclude 'node_modules/' \
              --exclude '.git/' \
              --exclude 'wp-content/uploads/' \
              ./wordpress/ $SSH_USER_PROD@$SSH_HOST_PROD:$DEPLOY_PATH_PROD
            - echo "Running post-deploy commands..."
            - ssh $SSH_USER_PROD@$SSH_HOST_PROD "cd $DEPLOY_PATH_PROD && wp core update-db --allow-root && wp theme activate ${THEME_NAME:-tiz} --allow-root && wp cache flush --allow-root && wp rewrite flush --allow-root"
            - echo "Post-deploy completed!"
           
options:
  size: 2x